<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èº²çŒ«çŒ« - æŒ‘æˆ˜æ¨¡å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 850px;
            width: 100%;
            position: relative;
            max-height: 98vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                max-height: 98vh;
            }
        }

        /* æ¬¢è¿é¡µé¢ */
        .welcome-screen {
            text-align: center;
            padding: 30px 20px;
        }

        .welcome-screen h1 {
            color: #667eea;
            font-size: clamp(1.5em, 5vw, 2.5em);
            margin-bottom: 10px;
            font-weight: bold;
        }

        .game-title {
            font-size: clamp(2em, 6vw, 3.5em);
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .welcome-screen .subtitle {
            font-size: clamp(1em, 3vw, 1.2em);
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .welcome-screen .challenge-info {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .challenge-info h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .challenge-info ul {
            text-align: left;
            display: inline-block;
            line-height: 2;
        }

        .challenge-info li {
            color: #555;
        }

        .challenge-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: clamp(1em, 3vw, 1.5em);
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .challenge-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }

        /* æ¸¸æˆé¡µé¢ */
        .game-screen {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            position: relative;
        }

        .game-content {
            flex: 1;
            display: flex;
            gap: 10px;
            min-height: 0;
        }

        .game-sidebar {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100px;
            flex-shrink: 0;
        }

        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 0;
        }

        h1 {
            display: none;
        }

        .settings-icon {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .settings-icon:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .settings-icon::before {
            content: 'âš™';
            color: white;
            font-size: 24px;
        }

        /* è®¾ç½®èœå• */
        .settings-menu {
            position: relative;
            z-index: 100;
        }

        .settings-dropdown {
            display: none;
            position: absolute;
            top: 45px;
            left: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            min-width: 150px;
            overflow: hidden;
            z-index: 101;
        }

        .settings-dropdown.show {
            display: block;
        }

        .settings-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-item:hover {
            background: #f5f5f5;
        }


        .level-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            margin: 0 10px;
        }

        .level-info h2 {
            font-size: clamp(0.85em, 2vw, 1em);
            margin: 0;
            display: inline;
        }

        .level-info .sub-level {
            font-size: clamp(0.75em, 1.8vw, 0.85em);
            opacity: 0.9;
            display: inline;
            margin-left: 10px;
        }

        /* æ¸¸æˆä¿¡æ¯é¢æ¿ */
        .game-info-panel {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .info-card {
            background: #f9f9f9;
            padding: 8px 6px;
            border-radius: 8px;
            text-align: center;
        }

        .info-label {
            font-size: clamp(0.7em, 1.8vw, 0.75em);
            color: #666;
            margin-bottom: 2px;
            display: block;
        }

        .info-value {
            font-size: clamp(0.95em, 2.2vw, 1.1em);
            font-weight: bold;
            color: #667eea;
            display: block;
        }

        /* å¸®åŠ©æŒ‰é’® */
        .help-btn-header {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border: none;
            font-size: 20px;
            flex-shrink: 0;
        }

        .help-btn-header:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        /* ç¼©æ”¾æŒ‰é’® */
        .zoom-btn {
            width: 40px;
            height: 40px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border: none;
            font-size: 18px;
            flex-shrink: 0;
            margin-right: 8px;
        }

        .zoom-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ç¼©æ”¾å°ºå¯¸ */
        .game-board.size-small {
            max-width: min(400px, 80vw);
        }

        .game-board.size-medium {
            max-width: min(550px, 90vw);
        }

        .game-board.size-large {
            max-width: min(700px, 95vw);
        }

        /* æ“ä½œæŒ‰é’® - éšè—åŸæ¥çš„å¸®åŠ©æŒ‰é’® */
        .action-btn {
            display: none;
        }

        .game-board {
            display: grid;
            gap: clamp(4px, 1vw, 8px);
            margin-bottom: 6px;
            aspect-ratio: 1;
            width: 100%;
            max-width: min(550px, 90vw);
            flex-shrink: 0;
            padding: 2%;
        }

        .color-block {
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        /* çŒ«è€³æœµ */
        .color-block::before,
        .color-block::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .color-block::before {
            top: 0;
            left: 20%;
            border-width: 0 6% 10% 6%;
            border-color: transparent transparent currentColor transparent;
            transform: translateY(-50%);
        }

        .color-block::after {
            top: 0;
            right: 20%;
            border-width: 0 6% 10% 6%;
            border-color: transparent transparent currentColor transparent;
            transform: translateY(-50%);
        }

        .color-block:hover {
            transform: scale(0.95);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .message {
            text-align: center;
            font-size: clamp(0.85em, 2vw, 1em);
            font-weight: bold;
            min-height: 20px;
            margin-bottom: 6px;
        }

        .success {
            color: #4CAF50;
        }

        .error {
            color: #f44336;
        }

        /* é€šå…³é¡µé¢ */
        .victory-screen {
            display: block;
            text-align: center;
            padding: 30px 20px;
        }

        .victory-screen h1 {
            color: #667eea;
            font-size: clamp(1.8em, 5vw, 3em);
            margin-bottom: 20px;
            animation: bounce 1s ease infinite;
        }

        .victory-screen .stats-summary {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .stats-summary h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .stats-summary .stat {
            font-size: clamp(1em, 2.5vw, 1.2em);
            margin: 10px 0;
            color: #555;
        }

        .stats-summary .stat strong {
            color: #667eea;
        }

        .restart-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 35px;
            font-size: clamp(1em, 2.5vw, 1.2em);
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .restart-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        /* æ’’èŠ±ç‰¹æ•ˆ */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f0f;
            animation: confetti-fall 3s linear forwards;
            z-index: 9999;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 0.3s ease;
        }

        .hidden {
            display: none !important;
        }

        /* å¸®åŠ©å¯¹è¯æ¡† */
        .help-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .help-dialog.show {
            display: flex;
        }

        .help-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .help-content h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: clamp(1.1em, 3vw, 1.3em);
        }

        .help-content p {
            margin-bottom: 20px;
            color: #666;
            font-size: clamp(0.9em, 2.5vw, 1em);
        }

        .help-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .help-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: clamp(0.9em, 2.5vw, 1em);
        }

        .help-btn-yes {
            background: #667eea;
            color: white;
        }

        .help-btn-yes:hover {
            background: #5568d3;
        }

        .help-btn-no {
            background: #f0f0f0;
            color: #333;
        }

        .help-btn-no:hover {
            background: #e0e0e0;
        }

        .hint-message {
            background: #fff3cd;
            color: #856404;
            padding: 6px;
            border-radius: 8px;
            margin-bottom: 6px;
            font-weight: bold;
            font-size: clamp(0.8em, 2vw, 0.9em);
        }

        /* å“åº”å¼è®¾è®¡ - å°å±å¹• */
        @media (max-width: 600px) {
            .game-content {
                flex-direction: column;
            }

            .game-sidebar {
                width: 100%;
                order: 2;
            }

            .game-info-panel {
                flex-direction: row;
                overflow-x: auto;
            }

            .info-card {
                min-width: 80px;
            }

            .game-main {
                order: 1;
            }

            .game-header {
                flex-wrap: wrap;
            }

            .level-info {
                order: 3;
                flex: 1 1 100%;
                margin: 8px 0 0 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¬¢è¿é¡µé¢ -->
        <div class="welcome-screen" id="welcomeScreen">
            <div class="game-title">ğŸ± èº²çŒ«çŒ« ğŸ±</div>
            <p class="subtitle">æŒ‘æˆ˜ä½ çš„çœ¼åŠ›å’Œååº”é€Ÿåº¦ï¼</p>

            <div class="challenge-info">
                <h3>ğŸ¯ æŒ‘æˆ˜è§„åˆ™</h3>
                <ul>
                    <li>ä»ç¬¬1å…³å¼€å§‹æŒ‘æˆ˜</li>
                    <li>æ¯å…³åŒ…å«5ä¸ªå°å…³å¡</li>
                    <li>æ¯å…³ç½‘æ ¼ä¼šé€æ¸å¢å¤§</li>
                    <li>æ‰¾å‡ºé¢œè‰²ä¸åŒçš„è‰²å—å³å¯è¿‡å…³</li>
                    <li>å®Œæˆæ‰€æœ‰å…³å¡å³ä¸ºé€šå…³ï¼</li>
                </ul>
            </div>

            <button class="challenge-btn" id="acceptChallengeBtn">æ¥å—æŒ‘æˆ˜</button>
        </div>

        <!-- æ¸¸æˆé¡µé¢ -->
        <div class="game-screen hidden" id="gameScreen">
            <!-- é¡¶éƒ¨åŒºåŸŸï¼šè®¾ç½®ã€å…³å¡ä¿¡æ¯ã€å¸®åŠ© -->
            <div class="game-header">
                <!-- è®¾ç½®èœå• -->
                <div class="settings-menu">
                    <div class="settings-icon" id="settingsIcon"></div>
                    <div class="settings-dropdown" id="settingsDropdown">
                        <div class="settings-item" id="soundToggle">ğŸ”Š éŸ³æ•ˆ: å¼€</div>
                        <div class="settings-item" id="pauseToggle">â¸ æš‚åœæ¸¸æˆ</div>
                        <div class="settings-item" id="quitGame">ğŸšª é€€å‡ºæ¸¸æˆ</div>
                    </div>
                </div>

                <!-- å…³å¡ä¿¡æ¯ -->
                <div class="level-info">
                    <h2>ç¬¬ <span id="currentLevel">1</span> å…³ - <span id="gridInfo">4Ã—4</span></h2>
                    <span class="sub-level">å°å…³: <span id="subLevel">1</span>/5</span>
                </div>

                <!-- å³ä¾§æ§åˆ¶æŒ‰é’® -->
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomBtn" title="ç¼©æ”¾">ğŸ”</button>
                    <button class="help-btn-header" id="helpBtn" title="å¸®åŠ©">ğŸ’¡</button>
                </div>
            </div>

            <h1>ğŸ¨ èº²çŒ«çŒ«</h1>

            <!-- ä¸»å†…å®¹åŒºåŸŸ -->
            <div class="game-content">
                <!-- å·¦ä¾§ä¿¡æ¯æ  -->
                <div class="game-sidebar">
                    <div class="game-info-panel">
                        <div class="info-card">
                            <div class="info-label">ç”¨æ—¶</div>
                            <div class="info-value" id="timeDisplay">0:00</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">å¾—åˆ†</div>
                            <div class="info-value" id="score">0</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">è¿å‡»</div>
                            <div class="info-value" id="combo">0</div>
                        </div>
                        <div class="info-card">
                            <div class="info-label">æ­£ç¡®ç‡</div>
                            <div class="info-value" id="accuracy">100%</div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§æ¸¸æˆåŒºåŸŸ -->
                <div class="game-main">
                    <div class="message" id="message"></div>
                    <div id="hintContainer"></div>
                    <div class="game-board" id="gameBoard"></div>
                </div>
            </div>

            <button class="action-btn" id="helpBtnOld">ğŸ’¡ å¸®åŠ©</button>
        </div>

        <!-- é€šå…³é¡µé¢ -->
        <div class="victory-screen hidden" id="victoryScreen">
            <h1 id="victoryTitle">ğŸ‰ æ­å–œé€šå…³ï¼</h1>

            <div class="stats-summary">
                <h3>ğŸ“Š æŒ‘æˆ˜ç»Ÿè®¡</h3>
                <div class="stat" id="completionStatus"></div>
                <div class="stat">æ€»ç”¨æ—¶: <strong id="finalTime">0:00</strong></div>
                <div class="stat">æ€»å¾—åˆ†: <strong id="finalScore">0</strong></div>
                <div class="stat">æ­£ç¡®æ¬¡æ•°: <strong id="finalCorrect">0</strong></div>
                <div class="stat">é”™è¯¯æ¬¡æ•°: <strong id="finalWrong">0</strong></div>
                <div class="stat">æœ€é«˜è¿å‡»: <strong id="finalMaxCombo">0</strong></div>
                <div class="stat">æ­£ç¡®ç‡: <strong id="finalAccuracy">0%</strong></div>
            </div>

            <button class="restart-btn" id="restartBtn">å†æ¥ä¸€æ¬¡</button>
        </div>
    </div>

    <!-- å¸®åŠ©å¯¹è¯æ¡† -->
    <div class="help-dialog" id="helpDialog">
        <div class="help-content">
            <h3>ğŸ’¡ éœ€è¦å¸®åŠ©å—ï¼Ÿ</h3>
            <p id="helpDialogText">æ˜¯å¦æ˜¾ç¤ºæç¤ºï¼Ÿ<br>ï¼ˆä¼šæ‰£é™¤éƒ¨åˆ†åˆ†æ•°ï¼‰</p>
            <div class="help-buttons">
                <button class="help-btn help-btn-yes" id="helpYes">æ˜¯çš„</button>
                <button class="help-btn help-btn-no" id="helpNo">ä¸ç”¨äº†</button>
            </div>
        </div>
    </div>

    <!-- å…³å¡å®Œæˆç¡®è®¤å¯¹è¯æ¡† -->
    <div class="help-dialog" id="levelCompleteDialog">
        <div class="help-content">
            <h3>ğŸ‰ æ­å–œå®Œæˆæœ¬å…³ï¼</h3>
            <p>æ˜¯å¦ç»§ç»­æŒ‘æˆ˜ä¸‹ä¸€å…³ï¼Ÿ</p>
            <div class="help-buttons">
                <button class="help-btn help-btn-yes" id="continueYes">æ˜¯</button>
                <button class="help-btn help-btn-no" id="continueNo">å¦</button>
            </div>
        </div>
    </div>

    <script>
        class ColorChallengeGame {
            constructor() {
                this.currentLevel = 1;
                this.subLevel = 1;
                this.maxSubLevels = 5;
                this.maxLevel = 7;
                this.score = 0;
                this.combo = 0;
                this.maxCombo = 0;
                this.correctCount = 0;
                this.wrongCount = 0;
                this.currentSubLevelWrongs = 0;
                this.isPaused = false;
                this.soundEnabled = true;
                this.differentBlockIndex = -1;
                this.startTime = null;
                this.elapsedTime = 0;
                this.timerInterval = null;
                this.hintCount = 0;
                this.maxHints = 3;
                this.zoomLevel = 'medium';

                this.initElements();
                this.initEventListeners();
            }

            initElements() {
                this.welcomeScreen = document.getElementById('welcomeScreen');
                this.gameScreen = document.getElementById('gameScreen');
                this.victoryScreen = document.getElementById('victoryScreen');
                this.gameBoard = document.getElementById('gameBoard');
                this.scoreEl = document.getElementById('score');
                this.comboEl = document.getElementById('combo');
                this.messageEl = document.getElementById('message');
                this.correctCountEl = document.getElementById('correctCount');
                this.currentLevelEl = document.getElementById('currentLevel');
                this.subLevelEl = document.getElementById('subLevel');
                this.gridInfoEl = document.getElementById('gridInfo');
                this.timeDisplayEl = document.getElementById('timeDisplay');
                this.accuracyEl = document.getElementById('accuracy');
                this.hintContainer = document.getElementById('hintContainer');
                this.settingsIcon = document.getElementById('settingsIcon');
                this.settingsDropdown = document.getElementById('settingsDropdown');
                this.helpDialog = document.getElementById('helpDialog');
                this.helpDialogText = document.getElementById('helpDialogText');
                this.levelCompleteDialog = document.getElementById('levelCompleteDialog');
                this.victoryTitle = document.getElementById('victoryTitle');
                this.completionStatus = document.getElementById('completionStatus');
            }

            initEventListeners() {
                const acceptBtn = document.getElementById('acceptChallengeBtn');
                const restartBtn = document.getElementById('restartBtn');
                const helpBtn = document.getElementById('helpBtn');
                const helpYes = document.getElementById('helpYes');
                const helpNo = document.getElementById('helpNo');
                const continueYes = document.getElementById('continueYes');
                const continueNo = document.getElementById('continueNo');
                const soundToggle = document.getElementById('soundToggle');
                const pauseToggle = document.getElementById('pauseToggle');
                const quitGame = document.getElementById('quitGame');
                const zoomBtn = document.getElementById('zoomBtn');

                if (acceptBtn) {
                    acceptBtn.addEventListener('click', () => this.startChallenge());
                }
                if (restartBtn) {
                    restartBtn.addEventListener('click', () => this.restartGame());
                }
                if (helpBtn) {
                    helpBtn.addEventListener('click', () => this.showHelpDialog());
                }
                if (helpYes) {
                    helpYes.addEventListener('click', () => this.provideHint());
                }
                if (helpNo) {
                    helpNo.addEventListener('click', () => this.hideHelpDialog());
                }
                if (zoomBtn) {
                    zoomBtn.addEventListener('click', () => this.toggleZoom());
                }
                if (continueYes) {
                    continueYes.addEventListener('click', () => this.continueToNextLevel());
                }
                if (continueNo) {
                    continueNo.addEventListener('click', () => this.declineContinue());
                }

                // è®¾ç½®èœå•
                this.settingsIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.settingsDropdown.classList.toggle('show');
                });

                document.addEventListener('click', () => {
                    this.settingsDropdown.classList.remove('show');
                });

                soundToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleSound();
                });

                pauseToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.togglePause();
                });

                quitGame.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.quitGameConfirm();
                });
            }

            startChallenge() {
                this.welcomeScreen.classList.add('hidden');
                this.gameScreen.classList.remove('hidden');
                this.currentLevel = 1;
                this.subLevel = 1;
                this.score = 0;
                this.combo = 0;
                this.maxCombo = 0;
                this.correctCount = 0;
                this.wrongCount = 0;
                this.elapsedTime = 0;
                this.hintCount = 0; // æ¸¸æˆå¼€å§‹æ—¶é‡ç½®æç¤ºæ¬¡æ•°
                this.startTimer();
                this.startLevel();
                this.playSound('start');
            }

            startTimer() {
                this.startTime = Date.now() - this.elapsedTime * 1000;
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }
                this.timerInterval = setInterval(() => {
                    if (!this.isPaused) {
                        this.elapsedTime = Math.floor((Date.now() - this.startTime) / 1000);
                        this.updateTimeDisplay();
                    }
                }, 1000);
            }

            stopTimer() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            }

            updateTimeDisplay() {
                const minutes = Math.floor(this.elapsedTime / 60);
                const seconds = this.elapsedTime % 60;
                this.timeDisplayEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }

            startLevel() {
                const gridSize = 3 + this.currentLevel;
                this.gridSize = gridSize;
                this.currentLevelEl.textContent = this.currentLevel;
                this.subLevelEl.textContent = this.subLevel;
                this.gridInfoEl.textContent = `${gridSize}Ã—${gridSize}`;
                this.currentSubLevelWrongs = 0; // é‡ç½®å½“å‰å°å…³çš„é”™è¯¯æ¬¡æ•°
                // ä¸åœ¨è¿™é‡Œé‡ç½®hintCountï¼Œæç¤ºæ¬¡æ•°åœ¨æ•´ä¸ªå¤§å…³ä¸­å…±äº«
                this.updateDisplay();
                this.generateBoard();
                this.showMessage(`ç¬¬${this.currentLevel}å…³ - å°å…³${this.subLevel}`, 'success');
            }

            generateBoard() {
                this.gameBoard.innerHTML = '';
                this.hintContainer.innerHTML = '';
                this.gameBoard.style.gridTemplateColumns = `repeat(${this.gridSize}, 1fr)`;

                // ç¡®ä¿åº”ç”¨å½“å‰çš„ç¼©æ”¾çº§åˆ«
                this.gameBoard.classList.remove('size-small', 'size-medium', 'size-large');
                this.gameBoard.classList.add(`size-${this.zoomLevel}`);

                const baseColor = this.getRandomColor();
                const differentColor = this.getDifferentColor(baseColor);
                this.differentBlockIndex = Math.floor(Math.random() * (this.gridSize * this.gridSize));

                for (let i = 0; i < this.gridSize * this.gridSize; i++) {
                    const block = document.createElement('div');
                    block.className = 'color-block';
                    const blockColor = i === this.differentBlockIndex ? differentColor : baseColor;
                    block.style.backgroundColor = blockColor;
                    block.style.color = blockColor; // è®¾ç½®colorå±æ€§ç”¨äºè€³æœµé¢œè‰²
                    block.addEventListener('click', () => this.handleBlockClick(i));
                    this.gameBoard.appendChild(block);
                }
            }

            getRandomColor() {
                const hue = Math.floor(Math.random() * 360);
                const saturation = 70 + Math.floor(Math.random() * 30);
                const lightness = 50 + Math.floor(Math.random() * 20);
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            getDifferentColor(baseColor) {
                const match = baseColor.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
                if (!match) return baseColor;

                let hue = parseInt(match[1]);
                let saturation = parseInt(match[2]);
                let lightness = parseInt(match[3]);

                const difficulty = Math.max(5, 20 - this.currentLevel * 2);
                lightness += Math.random() > 0.5 ? difficulty : -difficulty;
                lightness = Math.max(20, Math.min(90, lightness));

                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            handleBlockClick(index) {
                if (this.isPaused) return;

                if (index === this.differentBlockIndex) {
                    this.handleCorrect();
                } else {
                    this.handleWrong();
                }
            }

            handleCorrect() {
                this.correctCount++;
                this.combo++;
                this.maxCombo = Math.max(this.maxCombo, this.combo);

                const points = 10;
                this.score += points;

                this.updateDisplay();
                this.playSound('correct');

                this.gameBoard.classList.add('pulse');
                setTimeout(() => this.gameBoard.classList.remove('pulse'), 300);

                // æ£€æŸ¥æ˜¯å¦å®Œæˆå°å…³
                if (this.subLevel < this.maxSubLevels) {
                    this.subLevel++;
                    this.showMessage(`æ­£ç¡®ï¼+${points}åˆ†`, 'success');
                    setTimeout(() => this.startLevel(), 800);
                } else {
                    // å®Œæˆå½“å‰å¤§å…³ï¼Œæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
                    if (this.currentLevel < this.maxLevel) {
                        this.showMessage(`ç¬¬${this.currentLevel}å…³å®Œæˆï¼`, 'success');
                        setTimeout(() => this.showLevelCompleteDialog(), 1000);
                    } else {
                        // å…¨éƒ¨é€šå…³
                        this.showMessage('å…¨éƒ¨å®Œæˆï¼', 'success');
                        setTimeout(() => this.showVictory(), 1000);
                    }
                }
            }

            handleWrong() {
                this.wrongCount++;
                this.currentSubLevelWrongs++;
                this.combo = 0;

                // ä»ç¬¬ä¸‰æ¬¡é”™è¯¯å¼€å§‹æ‰£åˆ†
                if (this.currentSubLevelWrongs >= 3) {
                    const deduction = 3;
                    this.score = Math.max(0, this.score - deduction);
                    this.updateDisplay();
                    this.showMessage(`é”™è¯¯ï¼-${deduction}åˆ†ï¼ˆæœ¬å…³ç¬¬${this.currentSubLevelWrongs}æ¬¡é”™è¯¯ï¼‰`, 'error');
                } else {
                    this.updateDisplay();
                    this.showMessage(`é”™è¯¯ï¼å†è¯•ä¸€æ¬¡ï¼ˆæœ¬å…³ç¬¬${this.currentSubLevelWrongs}æ¬¡é”™è¯¯ï¼‰`, 'error');
                }

                this.playSound('wrong');
            }

            showVictory() {
                this.stopTimer();
                this.gameScreen.classList.add('hidden');
                this.victoryScreen.classList.remove('hidden');

                // è®¡ç®—å®Œæˆçš„å…³å¡æ•°
                const completedLevels = (this.currentLevel - 1) * this.maxSubLevels + this.subLevel;
                const totalLevels = this.maxLevel * this.maxSubLevels;
                const isFullyCompleted = this.currentLevel === this.maxLevel && this.subLevel === this.maxSubLevels;

                // è®¾ç½®æ ‡é¢˜å’Œå®ŒæˆçŠ¶æ€
                if (isFullyCompleted) {
                    this.victoryTitle.textContent = 'ğŸ‰ æ‚¨å®Œç¾é€šå…³ï¼';
                    this.completionStatus.innerHTML = '<strong style="color: #667eea; font-size: 1.2em;">æ­å–œæ‚¨å®Œæˆå…¨éƒ¨7å…³35ä¸ªå°å…³å¡ï¼</strong>';
                } else {
                    this.victoryTitle.textContent = 'ğŸ‰ æŒ‘æˆ˜ç»“æŸï¼';
                    this.completionStatus.innerHTML = `æ‚¨å·²å®Œæˆ <strong style="color: #667eea;">${completedLevels}</strong> ä¸ªå°å…³å¡ï¼`;
                }

                const minutes = Math.floor(this.elapsedTime / 60);
                const seconds = this.elapsedTime % 60;
                document.getElementById('finalTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('finalCorrect').textContent = this.correctCount;
                document.getElementById('finalWrong').textContent = this.wrongCount;
                document.getElementById('finalMaxCombo').textContent = this.maxCombo;

                const total = this.correctCount + this.wrongCount;
                const accuracy = total > 0 ? Math.round((this.correctCount / total) * 100) : 0;
                document.getElementById('finalAccuracy').textContent = accuracy + '%';

                this.createConfetti();
                this.playSound('victory');
            }

            createConfetti() {
                const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500'];
                const container = document.body;

                for (let i = 0; i < 150; i++) {
                    setTimeout(() => {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti';
                        confetti.style.left = Math.random() * 100 + '%';
                        confetti.style.top = '-10px';
                        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                        confetti.style.animationDelay = Math.random() * 0.5 + 's';
                        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                        container.appendChild(confetti);

                        setTimeout(() => confetti.remove(), 3000);
                    }, i * 20);
                }
            }

            showHelpDialog() {
                if (this.hintCount >= this.maxHints) {
                    this.showMessage('æç¤ºæ¬¡æ•°å·²ç”¨å®Œï¼', 'error');
                    return;
                }

                let dialogText = '';
                if (this.hintCount === 0) {
                    dialogText = 'ç¬¬1æ¬¡æç¤ºï¼šæ˜¾ç¤ºä¸åŒè‰²å—åœ¨å“ªä¸€è¡Œ<br>ï¼ˆæ‰£é™¤5åˆ†ï¼‰';
                } else if (this.hintCount === 1) {
                    dialogText = 'ç¬¬2æ¬¡æç¤ºï¼šæ˜¾ç¤ºä¸åŒè‰²å—åœ¨å“ªä¸€åˆ—<br>ï¼ˆæ‰£é™¤5åˆ†ï¼‰';
                } else if (this.hintCount === 2) {
                    dialogText = 'ç¬¬3æ¬¡æç¤ºï¼šæ˜¾ç¤ºä¸åŒè‰²å—çš„è¡Œå’Œåˆ—<br>ï¼ˆæ‰£é™¤10åˆ†ï¼‰';
                }

                this.helpDialogText.innerHTML = dialogText;
                this.helpDialog.classList.add('show');
                this.isPaused = true;
            }

            hideHelpDialog() {
                this.helpDialog.classList.remove('show');
                this.isPaused = false;
            }

            provideHint() {
                this.hideHelpDialog();

                const row = Math.floor(this.differentBlockIndex / this.gridSize) + 1;
                const col = (this.differentBlockIndex % this.gridSize) + 1;

                let hintText = '';
                let deduction = 0;

                if (this.hintCount === 0) {
                    // ç¬¬ä¸€æ¬¡æç¤ºï¼šåªæ˜¾ç¤ºè¡Œ
                    hintText = `ğŸ’¡ æç¤ºï¼šä¸åŒçš„è‰²å—åœ¨ç¬¬ ${row} è¡Œ`;
                    deduction = 5;
                } else if (this.hintCount === 1) {
                    // ç¬¬äºŒæ¬¡æç¤ºï¼šåªæ˜¾ç¤ºåˆ—
                    hintText = `ğŸ’¡ æç¤ºï¼šä¸åŒçš„è‰²å—åœ¨ç¬¬ ${col} åˆ—`;
                    deduction = 5;
                } else if (this.hintCount === 2) {
                    // ç¬¬ä¸‰æ¬¡æç¤ºï¼šæ˜¾ç¤ºè¡Œå’Œåˆ—
                    hintText = `ğŸ’¡ æç¤ºï¼šä¸åŒçš„è‰²å—åœ¨ç¬¬ ${row} è¡Œï¼Œç¬¬ ${col} åˆ—`;
                    deduction = 10;
                }

                this.hintCount++;
                this.score = Math.max(0, this.score - deduction);
                this.updateDisplay();

                this.hintContainer.innerHTML = `
                    <div class="hint-message">
                        ${hintText} ï¼ˆ-${deduction}åˆ†ï¼‰
                    </div>
                `;

                setTimeout(() => {
                    this.hintContainer.innerHTML = '';
                }, 5000);
            }

            showLevelCompleteDialog() {
                this.levelCompleteDialog.classList.add('show');
                this.isPaused = true;
            }

            hideLevelCompleteDialog() {
                this.levelCompleteDialog.classList.remove('show');
                this.isPaused = false;
            }

            continueToNextLevel() {
                this.hideLevelCompleteDialog();
                this.currentLevel++;
                this.subLevel = 1;
                this.hintCount = 0; // è¿›å…¥æ–°çš„å¤§å…³æ—¶é‡ç½®æç¤ºæ¬¡æ•°
                setTimeout(() => this.startLevel(), 500);
            }

            declineContinue() {
                this.hideLevelCompleteDialog();
                this.showMessage('æŒ‘æˆ˜ç»“æŸï¼', 'success');
                setTimeout(() => this.showVictory(), 1000);
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                const pauseToggle = document.getElementById('pauseToggle');
                pauseToggle.textContent = this.isPaused ? 'â–¶ ç»§ç»­æ¸¸æˆ' : 'â¸ æš‚åœæ¸¸æˆ';

                if (this.isPaused) {
                    this.gameBoard.style.opacity = '0.5';
                    this.gameBoard.style.pointerEvents = 'none';
                    this.showMessage('æ¸¸æˆå·²æš‚åœ', 'error');
                } else {
                    this.gameBoard.style.opacity = '1';
                    this.gameBoard.style.pointerEvents = 'auto';
                    this.showMessage('ç»§ç»­æ¸¸æˆ', 'success');
                }
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                const soundToggle = document.getElementById('soundToggle');
                soundToggle.textContent = this.soundEnabled ? 'ğŸ”Š éŸ³æ•ˆ: å¼€' : 'ğŸ”‡ éŸ³æ•ˆ: å…³';
            }

            toggleZoom() {
                const zoomLevels = ['small', 'medium', 'large'];
                const currentIndex = zoomLevels.indexOf(this.zoomLevel);
                const nextIndex = (currentIndex + 1) % zoomLevels.length;
                this.zoomLevel = zoomLevels[nextIndex];

                // ç§»é™¤æ‰€æœ‰å°ºå¯¸ç±»
                this.gameBoard.classList.remove('size-small', 'size-medium', 'size-large');
                // æ·»åŠ æ–°çš„å°ºå¯¸ç±»
                this.gameBoard.classList.add(`size-${this.zoomLevel}`);

                // æ˜¾ç¤ºæç¤º
                const sizeText = {
                    'small': 'å°',
                    'medium': 'ä¸­',
                    'large': 'å¤§'
                };
                this.showMessage(`ç¼©æ”¾: ${sizeText[this.zoomLevel]}`, 'success');
            }

            quitGameConfirm() {
                if (confirm('ç¡®å®šè¦é€€å‡ºå½“å‰æŒ‘æˆ˜å—ï¼Ÿè¿›åº¦å°†ä¸ä¼šä¿å­˜ã€‚')) {
                    this.stopTimer();
                    this.restartGame();
                }
            }

            restartGame() {
                this.stopTimer();
                this.gameScreen.classList.add('hidden');
                this.victoryScreen.classList.add('hidden');
                this.welcomeScreen.classList.remove('hidden');
            }

            updateDisplay() {
                this.scoreEl.textContent = this.score;
                this.comboEl.textContent = this.combo;

                const total = this.correctCount + this.wrongCount;
                const accuracy = total > 0 ? Math.round((this.correctCount / total) * 100) : 100;
                this.accuracyEl.textContent = accuracy + '%';
            }

            showMessage(text, type) {
                this.messageEl.textContent = text;
                this.messageEl.className = `message ${type}`;

                setTimeout(() => {
                    this.messageEl.textContent = '';
                    this.messageEl.className = 'message';
                }, 2000);
            }

            playSound(type) {
                if (!this.soundEnabled) return;

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                if (type === 'correct') {
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                } else if (type === 'wrong') {
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(100, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                } else if (type === 'start') {
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } else if (type === 'victory') {
                    const notes = [523.25, 587.33, 659.25, 783.99];
                    notes.forEach((note, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.setValueAtTime(note, audioContext.currentTime + i * 0.15);
                        gain.gain.setValueAtTime(0.3, audioContext.currentTime + i * 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.3);
                        osc.start(audioContext.currentTime + i * 0.15);
                        osc.stop(audioContext.currentTime + i * 0.15 + 0.3);
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const game = new ColorChallengeGame();
        });
    </script>
</body>
</html>